{% extends 'main/base.html' %}

{% block content %}
<div class="container-fluid mt-4">
    <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏</h2>
    
    <!-- –°–í–û–î–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø –° –ö–†–ê–°–ò–í–´–ú –î–ò–ó–ê–ô–ù–û–ú -->
    <div class="alert alert-info border-0 shadow-sm">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h5 class="mb-3">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏</h5>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number">{{ total_claims }}</div>
                        <div class="stat-label">–í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ –¥–æ–ª–∂–Ω–∏–∫–æ–≤</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">{{ debtors_over_60k }}</div>
                        <div class="stat-label">–î–æ–ª–≥ > 60,000 —Ä—É–±.</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">{{ generated_count }}</div>
                        <div class="stat-label">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ PDF –ø—Ä–µ—Ç–µ–Ω–∑–∏–π</div>
                    </div>
                </div>
            </div>
            <div class="text-end">
                <span class="badge bg-primary fs-6">AI Analysis</span>
            </div>
        </div>
        
        {% if all_debtors and all_debtors|length > 0 %}
        <div class="mt-4">
            <h6 class="d-flex align-items-center mb-3">
                <span class="debt-icon">üí∞</span>
                –í—Å–µ –¥–æ–ª–∂–Ω–∏–∫–∏ (–æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ —É–±—ã–≤–∞–Ω–∏—é –¥–æ–ª–≥–∞)
            </h6>
            <div class="debtors-list-container">
                <div class="debtors-list">
                    {% for claim in all_debtors %}
                    <div class="debtor-item 
                                {% if claim.debt_amount > 60000 %}high-debt{% else %}low-debt{% endif %} 
                                {% if claim.has_personal_data %}has-data{% else %}no-data{% endif %}">
                            <div class="debtor-main">
                                <span class="debtor-name">{{ claim.fio }}</span>
                                <span class="debtor-address">{{ claim.snt_address }}</span>
                                <div class="debtor-contacts">
                                    {% if claim.phone != '_________________________' %}
                                        <small class="text-success">üì± {{ claim.phone }}</small>
                                    {% endif %}
                                    {% if claim.email != '_________________________' %}
                                        <small class="text-primary">üìß {{ claim.email }}</small>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="debtor-details">
                                <span class="debt-amount {% if claim.debt_amount > 60000 %}text-danger{% else %}text-warning{% endif %}">
                                    {{ claim.debt_amount|floatformat:2 }} —Ä—É–±.
                                </span>
                                {% if claim.debt_amount > 60000 %}
                                <span class="badge high-debt-badge">
                                    <i class="bi bi-exclamation-triangle"></i>
                                    > 60k
                                </span>
                                {% else %}
                                <span class="badge low-debt-badge">
                                    <i class="bi bi-info-circle"></i>
                                    < 60k
                                </span>
                                {% endif %}
                                {% if claim.has_personal_data %}
                                <span class="badge has-data-badge">
                                    <i class="bi bi-check-circle"></i>
                                    –î–∞–Ω–Ω—ã–µ –µ—Å—Ç—å
                                </span>
                                {% else %}
                                <span class="badge no-data-badge">
                                    <i class="bi bi-exclamation-triangle"></i>
                                    –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
                <div class="scroll-hint">
                    <i class="bi bi-chevron-double-down"></i>
                    <span>–ü—Ä–æ–∫—Ä—É—Ç–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤—Å–µ—Ö –¥–æ–ª–∂–Ω–∏–∫–æ–≤</span>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- –ö–ù–û–ü–ö–ò –î–ï–ô–°–¢–í–ò–ô -->
    <div class="action-buttons mt-4">
        <div class="row">
            {% if has_zip %}
            <div class="col-md-4 mb-3">
                <a href="{% url 'download_business_zip' %}" class="btn btn-success btn-lg w-100 shadow">
                    <i class="bi bi-file-earmark-zip"></i>
                    –°–∫–∞—á–∞—Ç—å ZIP –∞—Ä—Ö–∏–≤ ({{ generated_count }} –ø—Ä–µ—Ç–µ–Ω–∑–∏–π)
                </a>
            </div>
            {% endif %}
            
            {% if all_debtors and all_debtors|length > 0 %}
            <div class="col-md-4 mb-3">
                <form method="post" action="{% url 'send_bulk_notifications' %}" class="w-100">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-warning btn-lg w-100 shadow">
                        <i class="bi bi-send"></i>
                        –†–∞—Å—Å—ã–ª–∫–∞ SMS –∏ Email
                    </button>
                </form>
            </div>
            {% endif %}
            
            <div class="col-md-4 mb-3">
                <a href="{% url 'business' %}" class="btn btn-outline-secondary btn-lg w-100">
                    <i class="bi bi-arrow-left"></i>
                    –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã
                </a>
            </div>
        </div>
    </div>

    <!-- –û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
    <!-- –î–û–õ–ñ–ù–ò–ö–ò, –ö–û–¢–û–†–´–ú –£–ñ–ï –û–¢–ü–†–ê–í–õ–Ø–õ–ò –ü–†–ï–¢–ï–ù–ó–ò–ò -->
    {% if already_contacted_claims and already_contacted_claims|length > 0 %}
    <div class="alert alert-warning mt-4 border-0 shadow-sm">
        <h5 class="d-flex align-items-center">
            <i class="bi bi-clock-history me-2"></i>
            –î–æ–ª–∂–Ω–∏–∫–∏, –∫–æ—Ç–æ—Ä—ã–º —Ä–∞–Ω–µ–µ –ø—Ä–µ—Ç–µ–Ω–∑–∏—è —É–∂–µ –±—ã–ª–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞
        </h5>
        <p class="mb-3 text-muted">–≠—Ç–∏–º –¥–æ–ª–∂–Ω–∏–∫–∞–º –Ω–µ –Ω—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –¥–æ—Å—É–¥–µ–±–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω–æ.</p>
        
        <div class="table-responsive">
            <table class="table table-sm table-hover">
                <thead class="table-light">
                    <tr>
                        <th>–§–ò–û</th>
                        <th>–£—á–∞—Å—Ç–æ–∫</th>
                        <th>–î–æ–ª–≥</th>
                        <th>–î–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                    </tr>
                </thead>
                <tbody>
                    {% for claim in already_contacted_claims %}
                    <tr>
                        <td><strong>{{ claim.fio }}</strong></td>
                        <td>{{ claim.snt_address }}</td>
                        <td><strong>{{ claim.debt_amount|floatformat:2 }} —Ä—É–±.</strong></td>
                        <td>{{ claim.date_contacted|default:"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ" }}</td>
                        <td>
                            <span class="badge bg-secondary">
                                <i class="bi bi-envelope-check"></i>
                                –£–∂–µ –ø–æ–ª—É—á–∞–ª –ø—Ä–µ—Ç–µ–Ω–∑–∏—é
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>

<style>
    /* –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –¥–æ–ª–≥–æ–≤ –∏ –¥–∞–Ω–Ω—ã—Ö */
    .debtor-item.has-data {
        border-left: 4px solid #28a745;
        background: #f8fff9;
    }
    
    .debtor-item.no-data {
        border-left: 4px solid #6c757d;
        background: #f8f9fa;
    }
    
    .debtor-item.high-debt.has-data {
        border-left: 4px solid #dc3545;
        background: #fff5f5;
    }
    
    .debtor-item.low-debt.has-data {
        border-left: 4px solid #ffc107;
        background: #fffbf0;
    }
    
    .debtor-item.high-debt.no-data {
        border-left: 4px solid #dc3545;
        background: #f8f9fa;
    }
    
    .debtor-item.low-debt.no-data {
        border-left: 4px solid #ffc107;
        background: #f8f9fa;
    }
    
    .high-debt-badge {
        background: #dc3545;
        color: white;
    }
    
    .low-debt-badge {
        background: #ffc107;
        color: #000;
    }
    
    .debtor-contacts {
        margin-top: 5px;
    }
    
    .debtor-contacts small {
        display: block;
        margin-bottom: 2px;
    }
    
    .action-buttons .btn {
        border-radius: 10px;
        padding: 15px;
        font-weight: 600;
    }
    
    /* –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .stat-item {
        text-align: center;
        padding: 15px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .stat-number {
        font-size: 24px;
        font-weight: bold;
        color: #0d6efd;
        margin-bottom: 5px;
    }
    
    .stat-label {
        font-size: 12px;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .debtors-list-container {
        position: relative;
        background: white;
        border-radius: 10px;
        padding: 0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .debtors-list {
        max-height: 650px;
        overflow-y: auto;
        padding: 15px;
    }
    
    .debtor-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 15px;
        margin-bottom: 8px;
        border-radius: 8px;
        transition: all 0.3s ease;
    }
    
    .debtor-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .debtor-main {
        flex: 1;
    }
    
    .debtor-name {
        font-weight: 600;
        color: #212529;
        display: block;
        margin-bottom: 2px;
    }
    
    .debtor-address {
        font-size: 12px;
        color: #6c757d;
    }
    
    .debtor-details {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .debt-amount {
        font-weight: bold;
        font-size: 14px;
    }
    
    .no-data-badge {
        background: #6c757d;
        color: white;
    }
    
    .has-data-badge {
        background: #28a745;
        color: white;
    }
    
    .debt-icon {
        font-size: 18px;
        margin-right: 8px;
    }
    
    .debtors-list::-webkit-scrollbar {
        width: 6px;
    }
    
    .debtors-list::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }
    
    .debtors-list::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
    }
    
    .debtors-list::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }
    
    .scroll-hint {
        text-align: center;
        padding: 10px;
        background: linear-gradient(transparent, #f8f9fa);
        border-top: 1px solid #dee2e6;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { opacity: 0.6; }
        50% { opacity: 1; }
        100% { opacity: 0.6; }
    }
    
    .alert {
        border-radius: 12px;
    }
    
    .badge {
        font-weight: 500;
    }
    
    .btn {
        border-radius: 8px;
        font-weight: 500;
    }
    
    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: 1fr;
            gap: 10px;
        }
        
        .debtor-item {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }
        
        .debtor-details {
            width: 100%;
            justify-content: space-between;
        }
        
        .stat-number {
            font-size: 20px;
        }
        
        .action-buttons .btn {
            margin-bottom: 10px;
        }
    }
</style>

<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
{% endblock %}